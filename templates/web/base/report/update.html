[% moderating = c.user && c.user.has_permission_to('moderate', problem.bodies_str_ids) %]

[% IF loop.first %]
<section class="full-width">
    <h4 class="static-with-rule">[% loc('Updates') %]</h4>
    <ul class="item-list item-list--updates">
[% END %]
        <li class="item-list__item item-list__item--updates">
          [% IF moderating; original_update = update.moderation_original_data %]
            <form method="post" action="/moderate/report/[% problem.id %]/update/[% update.id %]">
                <input type="hidden" name="token" value="[% csrf_token %]">
                <input type="button" class="btn js-moderate moderate-display" value="Moderate this update">
                <div class="moderate-edit">
                    <label><input type="checkbox" class="hide-document" name="update_hide">
                    Hide update completely?</label>
                    <label><input type="checkbox" name="update_show_name" [% update.anonymous ? '' : 'checked' %]>
                    Show name publicly?</label>
                    [% IF update.photo or original_update.photo %]
                        <label><input type="checkbox" name="update_show_photo" [% update.photo ? 'checked' : '' %]>
                        Show Photo?</label>
                    [% END %]
                </div>
          [% END %]
            <div class="item-list__update-wrap">
            [% IF update.whenanswered %]
                <div class="item-list__update-text">
                    <p class="meta-2">
                        [% INCLUDE meta_line %]
                        [% IF c.user_exists AND c.user.id == update.user_id AND !update.anonymous %]
                            <!-- TODO: Should this link to a page with server-side form, for users without JavaScript? -->
                            <a href="#" class="js-hide-name">([% loc('Hide your name?') %])</a>
                        [% END %]
                    </p>
                  [% IF c.user_exists AND c.user.id == update.user_id AND !update.anonymous %]
                    <!-- TODO: Do we want to ajax this in? -->
                    <!-- TODO: Should this work without javascript too? -->
                    <div class="box-warning hide-name-form">
                        <!-- TODO: URL or form with button? -->
                        <a href="#">[% loc('Hide my name in this update') %]</a>
                        <p>[% loc('Alternatively, we can hide your name on <strong>all of your reports and updates</strong> across the site:') %]</p>
                        <!-- TODO: URL or form with button? -->
                        <a href="#">[% loc('Hide my name everywhere') %]</a>
                    </div>
                  [%- END %]
                </div>
            [% ELSE %]
                <a name="update_[% update.id %]" class="internal-link-fixed-header"></a>
                [% INCLUDE 'report/photo.html' object=update %]
                <div class="item-list__update-text">
                    <div class="moderate-display">
                        [% update.text | add_links | html_para %]
                    </div>
                    [% IF moderating %]
                    <div class="moderate-edit">
                        [% IF update.text != original.detail %]
                        <label><input type="checkbox" name="update_revert_detail" class="revert-textarea">
                        Revert to original</label>
                        [% END %]
                        <textarea class="form-control" name="update_detail">[% update.text | add_links %]</textarea>
                    </div>
                    [% END %]

                    <p class="meta-2">
                        [% INCLUDE meta_line %]
                        [% IF c.user_exists AND c.user.id == update.user_id AND !update.anonymous %]
                            <!-- TODO: Should this link to a page with server-side form, for users without JavaScript? -->
                            <a href="#" class="js-hide-name">([% loc('Hide your name?') %])</a>
                        [% END %]
                        [% mlog = update.latest_moderation_log_entry(); IF mlog %]
                            <br /> Moderated by [% mlog.user.from_body.name %] at [% prettify_dt(mlog.whenedited) %]
                        [% END %]
                    </p>
                  [% IF c.user_exists AND c.user.id == update.user_id AND !update.anonymous %]
                    <!-- TODO: Do we want to ajax this in? -->
                    <!-- TODO: Should this work without javascript too? -->
                    <div class="box-warning hide-name-form">
                        <!-- TODO: URL or form with button? -->
                        <a href="#">[% loc('Hide my name in this update') %]</a>
                        <p>[% loc('Alternatively, we can hide your name on <strong>all of your updates</strong>:') %]</p>
                        <!-- TODO: URL or form with button? -->
                        <a href="#">[% loc('Hide my name on all my updates') %]</a>
                    </div>
                  [%- END %]
                </div>
            [% END %]
            </div>
            [% IF moderating %]
                <div class="moderate-edit">
                    <label for="moderation_reason">Moderation reason:</label>
                    <input type="text" class="form-control" name="moderation_reason"
                        placeholder="Describe why you are moderating this">
                    <input type="submit" class="red-btn" value="Save changes">
                    <input type="button" class="btn cancel" value="Discard changes">
                </div>
                </form>
            [% END %]
        </li>
[% IF loop.last %]
    </ul>
</section>
[% END %]
